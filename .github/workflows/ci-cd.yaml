name: CI & CD Pipeline Development

on:
  push:
    branches: [development]

jobs:
  build:
    name: Build & Push Image
    runs-on: [self-hosted, backend]
    environment: 'witzo-automation-development'
    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      - name: Free up disk space
        run: |
          sudo docker system prune -a --volumes --force
          sudo rm -rf /home/runner/_work/_temp/*
          [ -d /var/cache/apt ] && sudo apt-get clean

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Debug - Check workspace
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          echo "Current dir: $(pwd)"
          ls -la
          if [ -f "Dockerfile" ]; then
            echo "✓ Dockerfile found"
          else
            echo "✗ Dockerfile NOT found"
            exit 1
          fi

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | sudo docker login --username "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build the Docker image
        run: sudo docker build -t webomindapps1/witzo-automation-dev:latest .

      - name: Push to Docker Hub
        run: sudo docker push webomindapps1/witzo-automation-dev:latest


  deploy:
    name: Deploy to Self-Hosted
    needs: build
    runs-on: [self-hosted, backend]
    environment: 'witzo-automation-development'

    steps:
      - name: Checkout code (so we have a workspace dir)
        uses: actions/checkout@v3

      - name: Re-create .env file on the runner
        run: |
          cat > $GITHUB_WORKSPACE/.env <<'EOF'
          PORT=${{ secrets.PORT }}
          NODE_ENV=${{ secrets.NODE_ENV }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          REDIS_CACHE_HOST=${{ secrets.REDIS_CACHE_HOST }}
          REDIS_CACHE_PORT=${{ secrets.REDIS_CACHE_PORT }}
          REDIS_CACHE_PASSWORD=${{ secrets.REDIS_CACHE_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          ADMIN_JWT_SECRET=${{ secrets.ADMIN_JWT_SECRET }}
          COOKIE_SECRET=${{ secrets.COOKIE_SECRET }}
          ACCESS_TOKEN_EXPIRY_MINUTES=${{ secrets.ACCESS_TOKEN_EXPIRY_MINUTES }}
          REFRESH_TOKEN_EXPIRY_DAYS=${{ secrets.REFRESH_TOKEN_EXPIRY_DAYS }}
          VERIFICATION_CODE_EXPIRY_MINUTES=${{ secrets.VERIFICATION_CODE_EXPIRY_MINUTES }}
          MAX_VERIFICATION_ATTEMPTS=${{ secrets.MAX_VERIFICATION_ATTEMPTS }}
          ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          AUTO_MIGRATE=${{ secrets.AUTO_MIGRATE }}
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT }}
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          EMAIL_FROM=${{ secrets.EMAIL_FROM }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL=${{ secrets.OPENAI_MODEL }}
          PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}
          PINECONE_ENVIRONMENT=${{ secrets.PINECONE_ENVIRONMENT }}
          PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }}
          ANALYTICS_FLUSH_INTERVAL_SEC=${{ secrets.ANALYTICS_FLUSH_INTERVAL_SEC }}
          WEBHOOK_PROCESS_INTERVAL_SEC=${{ secrets.WEBHOOK_PROCESS_INTERVAL_SEC }}
          EOF

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | sudo docker login --username "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Pull Docker image
        run: sudo docker pull webomindapps1/witzo-automation-dev:latest

      - name: Stop & remove old container (if any)
        run: |
          docker stop cicd-pipeline-witzo-automation || true
          docker rm   cicd-pipeline-witzo-automation || true

      - name: Run Docker container
        run: |
          sudo docker run -d \
            --name cicd-pipeline-witzo-automation \
            -p 8080:8080 \
            --restart always \
            -v /home/ubuntu/logsfiles:/logs \
            --env-file $GITHUB_WORKSPACE/.env \
            webomindapps1/witzo-automation-dev:latest
